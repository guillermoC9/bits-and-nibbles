/*
    aria.c

    ARIA Encryption Routines

    (CC) Creative Commons 2018-2025 by Guillermo Amodeo Ojeda.

    I dedicate the software in this file to the public domain, so it is entirely free.
    Thus you may use it and/or redistribute it for whatever purpose you may choose.

    It is actually distributed with the hope that it would be useful to someone,
    but with no guarantee whatsoever. Not even the guarantee that it will work.

    Also, being free software, it is provided without warranty of any kind,
    not even the implied warranty of merchantability or fitness for a particular
    purpose. I also disclaim any liability arising from any use of this software.

    Read the CC license at https://creativecommons.org/publicdomain/zero/1.0/

    NOTES:

        - Written by Guillermo Amodeo Ojeda using info and code from RFC-5794
          and the reference files which comes in ARIA.ZIP from KISA, original 
          developer of the algorithm. You can found them here: 

          * RFF-5794    https://www.rfc-editor.org/rfc/rfc5794.html
          * ARIA.ZIP    https://seed.kisa.or.kr/kisa/Board/19/detailView.do


                                --oO0Oo--

*/

#include "aria.h"


static const unsigned int SBOX[4][256] =
{
    {  
        0x63, 0x7C, 0x77, 0x7B, 0xF2, 0x6B, 0x6F, 0xC5, 0x30, 0x01, 0x67, 0x2B, 0xFE, 0xD7, 0xAB, 0x76,
        0xCA, 0x82, 0xC9, 0x7D, 0xFA, 0x59, 0x47, 0xF0, 0xAD, 0xD4, 0xA2, 0xAF, 0x9C, 0xA4, 0x72, 0xC0,
        0xB7, 0xFD, 0x93, 0x26, 0x36, 0x3F, 0xF7, 0xCC, 0x34, 0xA5, 0xE5, 0xF1, 0x71, 0xD8, 0x31, 0x15,
        0x04, 0xC7, 0x23, 0xC3, 0x18, 0x96, 0x05, 0x9A, 0x07, 0x12, 0x80, 0xE2, 0xEB, 0x27, 0xB2, 0x75,
        0x09, 0x83, 0x2C, 0x1A, 0x1B, 0x6E, 0x5A, 0xA0, 0x52, 0x3B, 0xD6, 0xB3, 0x29, 0xE3, 0x2F, 0x84,
        0x53, 0xD1, 0x00, 0xED, 0x20, 0xFC, 0xB1, 0x5B, 0x6A, 0xCB, 0xBE, 0x39, 0x4A, 0x4C, 0x58, 0xCF,
        0xD0, 0xEF, 0xAA, 0xFB, 0x43, 0x4D, 0x33, 0x85, 0x45, 0xF9, 0x02, 0x7F, 0x50, 0x3C, 0x9F, 0xA8,
        0x51, 0xA3, 0x40, 0x8F, 0x92, 0x9D, 0x38, 0xF5, 0xBC, 0xB6, 0xDA, 0x21, 0x10, 0xFF, 0xF3, 0xD2,
        0xCD, 0x0C, 0x13, 0xEC, 0x5F, 0x97, 0x44, 0x17, 0xC4, 0xA7, 0x7E, 0x3D, 0x64, 0x5D, 0x19, 0x73,
        0x60, 0x81, 0x4F, 0xDC, 0x22, 0x2A, 0x90, 0x88, 0x46, 0xEE, 0xB8, 0x14, 0xDE, 0x5E, 0x0B, 0xDB,
        0xE0, 0x32, 0x3A, 0x0A, 0x49, 0x06, 0x24, 0x5C, 0xC2, 0xD3, 0xAC, 0x62, 0x91, 0x95, 0xE4, 0x79,
        0xE7, 0xC8, 0x37, 0x6D, 0x8D, 0xD5, 0x4E, 0xA9, 0x6C, 0x56, 0xF4, 0xEA, 0x65, 0x7A, 0xAE, 0x08,
        0xBA, 0x78, 0x25, 0x2E, 0x1C, 0xA6, 0xB4, 0xC6, 0xE8, 0xDD, 0x74, 0x1F, 0x4B, 0xBD, 0x8B, 0x8A,
        0x70, 0x3E, 0xB5, 0x66, 0x48, 0x03, 0xF6, 0x0E, 0x61, 0x35, 0x57, 0xB9, 0x86, 0xC1, 0x1D, 0x9E,
        0xE1, 0xF8, 0x98, 0x11, 0x69, 0xD9, 0x8E, 0x94, 0x9B, 0x1E, 0x87, 0xE9, 0xCE, 0x55, 0x28, 0xDF,
        0x8C, 0xA1, 0x89, 0x0D, 0xBF, 0xE6, 0x42, 0x68, 0x41, 0x99, 0x2D, 0x0F, 0xB0, 0x54, 0xBB, 0x16
    },
    {
        0xE2, 0x4E, 0x54, 0xFC, 0x94, 0xC2, 0x4A, 0xCC, 0x62, 0x0D, 0x6A, 0x46, 0x3C, 0x4D, 0x8B, 0xD1,
        0x5E, 0xFA, 0x64, 0xCB, 0xB4, 0x97, 0xBE, 0x2B, 0xBC, 0x77, 0x2E, 0x03, 0xD3, 0x19, 0x59, 0xC1,
        0x1D, 0x06, 0x41, 0x6B, 0x55, 0xF0, 0x99, 0x69, 0xEA, 0x9C, 0x18, 0xAE, 0x63, 0xDF, 0xE7, 0xBB,
        0x00, 0x73, 0x66, 0xFB, 0x96, 0x4C, 0x85, 0xE4, 0x3A, 0x09, 0x45, 0xAA, 0x0F, 0xEE, 0x10, 0xEB,
        0x2D, 0x7F, 0xF4, 0x29, 0xAC, 0xCF, 0xAD, 0x91, 0x8D, 0x78, 0xC8, 0x95, 0xF9, 0x2F, 0xCE, 0xCD,
        0x08, 0x7A, 0x88, 0x38, 0x5C, 0x83, 0x2A, 0x28, 0x47, 0xDB, 0xB8, 0xC7, 0x93, 0xA4, 0x12, 0x53,
        0xFF, 0x87, 0x0E, 0x31, 0x36, 0x21, 0x58, 0x48, 0x01, 0x8E, 0x37, 0x74, 0x32, 0xCA, 0xE9, 0xB1,
        0xB7, 0xAB, 0x0C, 0xD7, 0xC4, 0x56, 0x42, 0x26, 0x07, 0x98, 0x60, 0xD9, 0xB6, 0xB9, 0x11, 0x40,
        0xEC, 0x20, 0x8C, 0xBD, 0xA0, 0xC9, 0x84, 0x04, 0x49, 0x23, 0xF1, 0x4F, 0x50, 0x1F, 0x13, 0xDC,
        0xD8, 0xC0, 0x9E, 0x57, 0xE3, 0xC3, 0x7B, 0x65, 0x3B, 0x02, 0x8F, 0x3E, 0xE8, 0x25, 0x92, 0xE5,
        0x15, 0xDD, 0xFD, 0x17, 0xA9, 0xBF, 0xD4, 0x9A, 0x7E, 0xC5, 0x39, 0x67, 0xFE, 0x76, 0x9D, 0x43,
        0xA7, 0xE1, 0xD0, 0xF5, 0x68, 0xF2, 0x1B, 0x34, 0x70, 0x05, 0xA3, 0x8A, 0xD5, 0x79, 0x86, 0xA8,
        0x30, 0xC6, 0x51, 0x4B, 0x1E, 0xA6, 0x27, 0xF6, 0x35, 0xD2, 0x6E, 0x24, 0x16, 0x82, 0x5F, 0xDA,
        0xE6, 0x75, 0xA2, 0xEF, 0x2C, 0xB2, 0x1C, 0x9F, 0x5D, 0x6F, 0x80, 0x0A, 0x72, 0x44, 0x9B, 0x6C,
        0x90, 0x0B, 0x5B, 0x33, 0x7D, 0x5A, 0x52, 0xF3, 0x61, 0xA1, 0xF7, 0xB0, 0xD6, 0x3F, 0x7C, 0x6D,
        0xED, 0x14, 0xE0, 0xA5, 0x3D, 0x22, 0xB3, 0xF8, 0x89, 0xDE, 0x71, 0x1A, 0xAF, 0xBA, 0xB5, 0x81
    },
    {
        0x52, 0x09, 0x6A, 0xD5, 0x30, 0x36, 0xA5, 0x38, 0xBF, 0x40, 0xA3, 0x9E, 0x81, 0xF3, 0xD7, 0xFB,
        0x7C, 0xE3, 0x39, 0x82, 0x9B, 0x2F, 0xFF, 0x87, 0x34, 0x8E, 0x43, 0x44, 0xC4, 0xDE, 0xE9, 0xCB,
        0x54, 0x7B, 0x94, 0x32, 0xA6, 0xC2, 0x23, 0x3D, 0xEE, 0x4C, 0x95, 0x0B, 0x42, 0xFA, 0xC3, 0x4E,
        0x08, 0x2E, 0xA1, 0x66, 0x28, 0xD9, 0x24, 0xB2, 0x76, 0x5B, 0xA2, 0x49, 0x6D, 0x8B, 0xD1, 0x25,
        0x72, 0xF8, 0xF6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xD4, 0xA4, 0x5C, 0xCC, 0x5D, 0x65, 0xB6, 0x92,
        0x6C, 0x70, 0x48, 0x50, 0xFD, 0xED, 0xB9, 0xDA, 0x5E, 0x15, 0x46, 0x57, 0xA7, 0x8D, 0x9D, 0x84,
        0x90, 0xD8, 0xAB, 0x00, 0x8C, 0xBC, 0xD3, 0x0A, 0xF7, 0xE4, 0x58, 0x05, 0xB8, 0xB3, 0x45, 0x06,
        0xD0, 0x2C, 0x1E, 0x8F, 0xCA, 0x3F, 0x0F, 0x02, 0xC1, 0xAF, 0xBD, 0x03, 0x01, 0x13, 0x8A, 0x6B,
        0x3A, 0x91, 0x11, 0x41, 0x4F, 0x67, 0xDC, 0xEA, 0x97, 0xF2, 0xCF, 0xCE, 0xF0, 0xB4, 0xE6, 0x73,
        0x96, 0xAC, 0x74, 0x22, 0xE7, 0xAD, 0x35, 0x85, 0xE2, 0xF9, 0x37, 0xE8, 0x1C, 0x75, 0xDF, 0x6E,
        0x47, 0xF1, 0x1A, 0x71, 0x1D, 0x29, 0xC5, 0x89, 0x6F, 0xB7, 0x62, 0x0E, 0xAA, 0x18, 0xBE, 0x1B,
        0xFC, 0x56, 0x3E, 0x4B, 0xC6, 0xD2, 0x79, 0x20, 0x9A, 0xDB, 0xC0, 0xFE, 0x78, 0xCD, 0x5A, 0xF4,
        0x1F, 0xDD, 0xA8, 0x33, 0x88, 0x07, 0xC7, 0x31, 0xB1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xEC, 0x5F,
        0x60, 0x51, 0x7F, 0xA9, 0x19, 0xB5, 0x4A, 0x0D, 0x2D, 0xE5, 0x7A, 0x9F, 0x93, 0xC9, 0x9C, 0xEF,
        0xA0, 0xE0, 0x3B, 0x4D, 0xAE, 0x2A, 0xF5, 0xB0, 0xC8, 0xEB, 0xBB, 0x3C, 0x83, 0x53, 0x99, 0x61,
        0x17, 0x2B, 0x04, 0x7E, 0xBA, 0x77, 0xD6, 0x26, 0xE1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0C, 0x7D
    },
    {
        0x30, 0x68, 0x99, 0x1B, 0x87, 0xB9, 0x21, 0x78, 0x50, 0x39, 0xDB, 0xE1, 0x72, 0x09, 0x62, 0x3C,
        0x3E, 0x7E, 0x5E, 0x8E, 0xF1, 0xA0, 0xCC, 0xA3, 0x2A, 0x1D, 0xFB, 0xB6, 0xD6, 0x20, 0xC4, 0x8D,
        0x81, 0x65, 0xF5, 0x89, 0xCB, 0x9D, 0x77, 0xC6, 0x57, 0x43, 0x56, 0x17, 0xD4, 0x40, 0x1A, 0x4D,
        0xC0, 0x63, 0x6C, 0xE3, 0xB7, 0xC8, 0x64, 0x6A, 0x53, 0xAA, 0x38, 0x98, 0x0C, 0xF4, 0x9B, 0xED,
        0x7F, 0x22, 0x76, 0xAF, 0xDD, 0x3A, 0x0B, 0x58, 0x67, 0x88, 0x06, 0xC3, 0x35, 0x0D, 0x01, 0x8B,
        0x8C, 0xC2, 0xE6, 0x5F, 0x02, 0x24, 0x75, 0x93, 0x66, 0x1E, 0xE5, 0xE2, 0x54, 0xD8, 0x10, 0xCE,
        0x7A, 0xE8, 0x08, 0x2C, 0x12, 0x97, 0x32, 0xAB, 0xB4, 0x27, 0x0A, 0x23, 0xDF, 0xEF, 0xCA, 0xD9,
        0xB8, 0xFA, 0xDC, 0x31, 0x6B, 0xD1, 0xAD, 0x19, 0x49, 0xBD, 0x51, 0x96, 0xEE, 0xE4, 0xA8, 0x41,
        0xDA, 0xFF, 0xCD, 0x55, 0x86, 0x36, 0xBE, 0x61, 0x52, 0xF8, 0xBB, 0x0E, 0x82, 0x48, 0x69, 0x9A,
        0xE0, 0x47, 0x9E, 0x5C, 0x04, 0x4B, 0x34, 0x15, 0x79, 0x26, 0xA7, 0xDE, 0x29, 0xAE, 0x92, 0xD7,
        0x84, 0xE9, 0xD2, 0xBA, 0x5D, 0xF3, 0xC5, 0xB0, 0xBF, 0xA4, 0x3B, 0x71, 0x44, 0x46, 0x2B, 0xFC,
        0xEB, 0x6F, 0xD5, 0xF6, 0x14, 0xFE, 0x7C, 0x70, 0x5A, 0x7D, 0xFD, 0x2F, 0x18, 0x83, 0x16, 0xA5,
        0x91, 0x1F, 0x05, 0x95, 0x74, 0xA9, 0xC1, 0x5B, 0x4A, 0x85, 0x6D, 0x13, 0x07, 0x4F, 0x4E, 0x45,
        0xB2, 0x0F, 0xC9, 0x1C, 0xA6, 0xBC, 0xEC, 0x73, 0x90, 0x7B, 0xCF, 0x59, 0x8F, 0xA1, 0xF9, 0x2D,
        0xF2, 0xB1, 0x00, 0x94, 0x37, 0x9F, 0xD0, 0x2E, 0x9C, 0x6E, 0x28, 0x3F, 0x80, 0xF0, 0x3D, 0xD3,
        0x25, 0x8A, 0xB5, 0xE7, 0x42, 0xB3, 0xC7, 0xEA, 0xF7, 0x4C, 0x11, 0x33, 0x03, 0xA2, 0xAC, 0x60
    }
 };

/* ---------------------------- */

 static const unsigned int KRK[3][4] = 
 {
    {0x517cc1b7, 0x27220a94, 0xfe13abe8, 0xfa9a6ee0},
    {0x6db14acc, 0x9e21c820, 0xff28b1d5, 0xef5de2b0},
    {0xdb92371d, 0x2126e970, 0x03249775, 0x04e8c90e}
};

/* ---------------------------- */

#define BRF(_src,_idx,_shf)         ((_src[_idx / 4] >> _shf) & 0xff)
#define SBX(_box,_src,_idx,_shf)    SBOX[_box][((_src[_idx / 4] >> _shf) & 0xff) ]

 /* ---------------------------- *
    S-Box Layer 1
 * ---------------------------- */

#define aria_SL1(_dst, _src) \
{\
    _dst[0]  = SBX(0,_src, 0,24) << 24; \
    _dst[0] |= SBX(1,_src, 1,16) << 16; \
    _dst[0] |= SBX(2,_src, 2, 8) <<  8; \
    _dst[0] |= SBX(3,_src, 3, 0) <<  0; \
    _dst[1]  = SBX(0,_src, 4,24) << 24; \
    _dst[1] |= SBX(1,_src, 5,16) << 16; \
    _dst[1] |= SBX(2,_src, 6, 8) <<  8; \
    _dst[1] |= SBX(3,_src, 7, 0) <<  0; \
    _dst[2]  = SBX(0,_src, 8,24) << 24; \
    _dst[2] |= SBX(1,_src, 9,16) << 16; \
    _dst[2] |= SBX(2,_src,10, 8) <<  8; \
    _dst[2] |= SBX(3,_src,11, 0) <<  0; \
    _dst[3]  = SBX(0,_src,12,24) << 24; \
    _dst[3] |= SBX(1,_src,13,16) << 16; \
    _dst[3] |= SBX(2,_src,14, 8) <<  8; \
    _dst[3] |= SBX(3,_src,15, 0) <<  0; \
}

/* ---------------------------- *
    S-Box Layer 2
 * ---------------------------- */

#define aria_SL2(_dst, _src) \
{\
    _dst[0]  = SBX(2,_src, 0,24) << 24; \
    _dst[0] |= SBX(3,_src, 1,16) << 16; \
    _dst[0] |= SBX(0,_src, 2, 8) <<  8; \
    _dst[0] |= SBX(1,_src, 3, 0) <<  0; \
    _dst[1]  = SBX(2,_src, 4,24) << 24; \
    _dst[1] |= SBX(3,_src, 5,16) << 16; \
    _dst[1] |= SBX(0,_src, 6, 8) <<  8; \
    _dst[1] |= SBX(1,_src, 7, 0) <<  0; \
    _dst[2]  = SBX(2,_src, 8,24) << 24; \
    _dst[2] |= SBX(3,_src, 9,16) << 16; \
    _dst[2] |= SBX(0,_src,10, 8) << 8 ; \
    _dst[2] |= SBX(1,_src,11, 0) <<  0; \
    _dst[3]  = SBX(2,_src,12,24) << 24; \
    _dst[3] |= SBX(3,_src,13,16) << 16; \
    _dst[3] |= SBX(0,_src,14, 8) <<  8; \
    _dst[3] |= SBX(1,_src,15, 0) <<  0; \
}

/* ---------------------------- *
    Diffusion Layer
 * ---------------------------- */

static void  aria_DL(unsigned int *dst, unsigned int *src) 
{ 
    dst[0]  = (BRF(src,3, 0) ^ BRF(src,4,24) ^ BRF(src,6, 8) ^ BRF(src, 8,24) ^ BRF(src, 9,16) ^ BRF(src,13,16) ^ BRF(src,14, 8)) << 24; 
    dst[0] |= (BRF(src,2, 8) ^ BRF(src,5,16) ^ BRF(src,7, 0) ^ BRF(src, 8,24) ^ BRF(src, 9,16) ^ BRF(src,12,24) ^ BRF(src,15, 0)) << 16; 
    dst[0] |= (BRF(src,1,16) ^ BRF(src,4,24) ^ BRF(src,6, 8) ^ BRF(src,10, 8) ^ BRF(src,11, 0) ^ BRF(src,12,24) ^ BRF(src,15, 0)) <<  8; 
    dst[0] |= (BRF(src,0,24) ^ BRF(src,5,16) ^ BRF(src,7, 0) ^ BRF(src,10, 8) ^ BRF(src,11, 0) ^ BRF(src,13,16) ^ BRF(src,14, 8)) <<  0; 

    dst[1]  = (BRF(src,0,24) ^ BRF(src,2, 8) ^ BRF(src,5,16) ^ BRF(src, 8,24) ^ BRF(src,11, 0) ^ BRF(src,14, 8) ^ BRF(src,15, 0)) << 24; 
    dst[1] |= (BRF(src,1,16) ^ BRF(src,3, 0) ^ BRF(src,4,24) ^ BRF(src, 9,16) ^ BRF(src,10, 8) ^ BRF(src,14, 8) ^ BRF(src,15, 0)) << 16; 
    dst[1] |= (BRF(src,0,24) ^ BRF(src,2, 8) ^ BRF(src,7, 0) ^ BRF(src, 9,16) ^ BRF(src,10, 8) ^ BRF(src,12,24) ^ BRF(src,13,16)) <<  8; 
    dst[1] |= (BRF(src,1,16) ^ BRF(src,3, 0) ^ BRF(src,6, 8) ^ BRF(src, 8,24) ^ BRF(src,11, 0) ^ BRF(src,12,24) ^ BRF(src,13,16)) <<  0; 

    dst[2]  = (BRF(src,0,24) ^ BRF(src,1,16) ^ BRF(src,4,24) ^ BRF(src, 7, 0) ^ BRF(src,10, 8) ^ BRF(src,13,16) ^ BRF(src,15, 0)) << 24; 
    dst[2] |= (BRF(src,0,24) ^ BRF(src,1,16) ^ BRF(src,5,16) ^ BRF(src, 6, 8) ^ BRF(src,11, 0) ^ BRF(src,12,24) ^ BRF(src,14, 8)) << 16; 
    dst[2] |= (BRF(src,2, 8) ^ BRF(src,3, 0) ^ BRF(src,5,16) ^ BRF(src, 6, 8) ^ BRF(src, 8,24) ^ BRF(src,13,16) ^ BRF(src,15, 0)) <<  8; 
    dst[2] |= (BRF(src,2, 8) ^ BRF(src,3, 0) ^ BRF(src,4,24) ^ BRF(src, 7, 0) ^ BRF(src, 9,16) ^ BRF(src,12,24) ^ BRF(src,14, 8)) <<  0; 

    dst[3]  = (BRF(src,1,16) ^ BRF(src,2, 8) ^ BRF(src,6, 8) ^ BRF(src, 7, 0) ^ BRF(src, 9,16) ^ BRF(src,11, 0) ^ BRF(src,12,24)) << 24; 
    dst[3] |= (BRF(src,0,24) ^ BRF(src,3, 0) ^ BRF(src,6, 8) ^ BRF(src, 7, 0) ^ BRF(src, 8,24) ^ BRF(src,10, 8) ^ BRF(src,13,16)) << 16; 
    dst[3] |= (BRF(src,0,24) ^ BRF(src,3, 0) ^ BRF(src,4,24) ^ BRF(src, 5,16) ^ BRF(src, 9,16) ^ BRF(src,11, 0) ^ BRF(src,14, 8)) <<  8; 
    dst[3] |= (BRF(src,1,16) ^ BRF(src,2, 8) ^ BRF(src,4,24) ^ BRF(src, 5,16) ^ BRF(src, 8,24) ^ BRF(src,10, 8) ^ BRF(src,15, 0)) <<  0; 
}

/* ---------------------------- *
    Rotation Layer
 * ---------------------------- */

static void aria_ROTXOR(unsigned int *dst, unsigned int *rot, unsigned int *src,size_t n) 
{ 
    size_t pos,shf,rem;

    pos = (n / 32);
    shf = n % 32;
    rem = 32 - shf;

    dst[0] = src[0] ^ ((rot[(pos + 0) % 4] <<  shf) |  (rot[(pos + 1) % 4] >> rem)); 
    dst[1] = src[1] ^ ((rot[(pos + 1) % 4] <<  shf) |  (rot[(pos + 2) % 4] >> rem)); 
    dst[2] = src[2] ^ ((rot[(pos + 2) % 4] <<  shf) |  (rot[(pos + 3) % 4] >> rem)); 
    dst[3] = src[3] ^ ((rot[(pos + 3) % 4] <<  shf) |  (rot[(pos + 0) % 4] >> rem)); 
}

/* ---------------------------- */

#define aria_SET(_dst, _src)        _dst[0]  = _src[0]; _dst[1]  = _src[1]; _dst[2]  = _src[2]; _dst[3]  = _src[3]; 
#define aria_XOR(_dst, _src)        _dst[0] ^= _src[0]; _dst[1] ^= _src[1]; _dst[2] ^= _src[2]; _dst[3] ^= _src[3];

/* ---------------------------- */

static void aria_ODD(unsigned int *dst, const unsigned int *src)
{
    unsigned int tmp[4];
  
    aria_XOR(dst, src);
    aria_SL1(tmp, dst);
    aria_DL(dst, tmp);
}

/* ---------------------------- */
    
 static void aria_EVEN(unsigned int *dst, const unsigned int *src)
 {
    unsigned int tmp[4];
  
    aria_XOR(dst, src);
    aria_SL2(tmp, dst);
    aria_DL(dst, tmp);
 }

 /* ---------------------------- *
    Set up ARIA's encdding and 
    decoding keys  
  * ---------------------------- */

static void aria_keys_setup(aria_t *ctx,const unsigned char *key) 
{
    unsigned int i,w[ARIA_NUM_IB][ARIA_NUM_IB] = {0};
    
    /* Encription round key generation  */    

    for(i = 0; i < ctx->kbits / 32; i++)
        w[0][i] = get_be32(key + i * 4);

    aria_SET(w[2], w[1]);
  
    aria_SET(w[1], w[0]);
    aria_ODD(w[1], ctx->kr0);
    aria_XOR(w[1], w[2]);
  
    aria_SET(w[2], w[1]);
    aria_EVEN(w[2],ctx->kr1);
    aria_XOR(w[2], w[0]);
  
    aria_SET(w[3], w[2]);
    aria_ODD(w[3], ctx->kr2);
    aria_XOR(w[3], w[1]);
    
    aria_ROTXOR(ctx->enckeysched[ 0], w[1],w[0],109);
    aria_ROTXOR(ctx->enckeysched[ 1], w[2],w[1],109);
    aria_ROTXOR(ctx->enckeysched[ 2], w[3],w[2],109);
    aria_ROTXOR(ctx->enckeysched[ 3], w[0],w[3],109);
    aria_ROTXOR(ctx->enckeysched[ 4], w[1],w[0], 97);
    aria_ROTXOR(ctx->enckeysched[ 5], w[2],w[1], 97);
    aria_ROTXOR(ctx->enckeysched[ 6], w[3],w[2], 97);
    aria_ROTXOR(ctx->enckeysched[ 7], w[0],w[3], 97);
    aria_ROTXOR(ctx->enckeysched[ 8], w[1],w[0], 61);
    aria_ROTXOR(ctx->enckeysched[ 9], w[2],w[1], 61);
    aria_ROTXOR(ctx->enckeysched[10], w[3],w[2], 61);
    aria_ROTXOR(ctx->enckeysched[11], w[0],w[3], 61);
    aria_ROTXOR(ctx->enckeysched[12], w[1],w[0], 31);
    aria_ROTXOR(ctx->enckeysched[13], w[2],w[1], 31);
    aria_ROTXOR(ctx->enckeysched[14], w[3],w[2], 31);
    aria_ROTXOR(ctx->enckeysched[15], w[0],w[3], 31);
    aria_ROTXOR(ctx->enckeysched[16], w[1],w[0], 19);
    
    /* Decription round key generation from encription key */

    aria_SET(ctx->deckeysched[0], ctx->enckeysched[ctx->nr]);

    for(i = 1; i < ctx->nr; i++)
       aria_DL(ctx->deckeysched[i], ctx->enckeysched[(ctx->nr - i)]);
    
    aria_SET(ctx->deckeysched[i], ctx->enckeysched[0]);      
 }

/* ---------------------------- *
    ARIA's block enconding and
    decoding function
  * ---------------------------- */

static void aria_crypt_block(aria_t *ctx,unsigned int key[ARIA_KEY_IB][ARIA_NUM_IB],unsigned char *iblk,unsigned char *oblk)
{	
    unsigned int p[4], q[4];
  
    p[0] = get_be32(iblk);
    p[1] = get_be32(iblk + 4);
    p[2] = get_be32(iblk + 8);
    p[3] = get_be32(iblk + 12);
      
    aria_ODD(p, key[0]); aria_EVEN(p, key[1]);
    aria_ODD(p, key[2]); aria_EVEN(p, key[3]);
    aria_ODD(p, key[4]); aria_EVEN(p, key[5]);
    aria_ODD(p, key[6]); aria_EVEN(p, key[7]);
    aria_ODD(p, key[8]); aria_EVEN(p, key[9]);    
  
    switch(ctx->nr)
    {
        case 12:    /* 128 bits */
            aria_ODD(p, key[10]);
            aria_XOR(p, key[11]);
            aria_SL2(q, p);
            aria_XOR(q, key[12]);
            break;
        case 14:    /* 192 bits */
            aria_ODD(p, key[10]);
            aria_EVEN(p, key[11]);
            aria_ODD(p, key[12]);
            aria_XOR(p, key[13]);
            aria_SL2(q, p);
            aria_XOR(q, key[14]);
            break;
        default:  /* 256 bits (16 rounds) */
            aria_ODD(p, key[10]);
            aria_EVEN(p, key[11]);
            aria_ODD(p, key[12]);
            aria_EVEN(p, key[13]);
            aria_ODD(p, key[14]);
            aria_XOR(p, key[15]);
            aria_SL2(q, p);
            aria_XOR(q, key[16]);
            break;
    }
  
    put_be32(oblk +  0, q[0]);
    put_be32(oblk +  4, q[1]);
    put_be32(oblk +  8, q[2]);
    put_be32(oblk + 12, q[3]);
}

/* ---------------------------- */
/* ---------------------------- */

void aria_encode_block(aria_t *ctx,void *dest,const void *orig)
{    
    aria_crypt_block(ctx,ctx->enckeysched,(unsigned char *)orig,(unsigned char *)dest);    
}

/* ---------------------------- */

void aria_decode_block(aria_t *ctx,void *dest,const void *orig)
{
    aria_crypt_block(ctx,ctx->deckeysched,(unsigned char *)orig,(unsigned char *)dest);
}

/* ---------------------------- */

int aria_init(aria_t *ctx,int bits,const void *key)
{    
    if(ctx && key)
    {
        memset(ctx,0,sizeof(aria_t));
    
        switch(bits)
        {
            case 128:
                ctx->nr = 12;
                ctx->kr0=KRK[0]; 
                ctx->kr1=KRK[1]; 
                ctx->kr2=KRK[2];
                break;
            case 192:
                ctx->nr = 14;
                ctx->kr0=KRK[1]; 
                ctx->kr1=KRK[2]; 
                ctx->kr2=KRK[0];
                break;
            case 256:
                ctx->nr = 16;
                ctx->kr0=KRK[2]; 
                ctx->kr1=KRK[0]; 
                ctx->kr2=KRK[1];
                break;
            default:
                return -1;
        }

        ctx->kbits = bits;

        aria_keys_setup(ctx,(unsigned char *)key);

        return 0;
    }
    return -1;
}

