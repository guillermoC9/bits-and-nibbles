/*
    pdf_fnt.c

    Portable Document Format (.PDF) Font Handling

    (CC) Creative Commons 2021-2025 by Guillermo Amodeo Ojeda.

    I dedicate the software in this file to the public domain, so it is entirely free.
    Thus you may use it and/or redistribute it for whatever purpose you may choose.

    It is actually distributed with the hope that it would be useful to someone,
    but with no guarantee whatsoever. Not even the guarantee that it will work.

    Also, being free software, it is provided without warranty of any kind,
    not even the implied warranty of merchantability or fitness for a particular
    purpose. I also disclaim any liability arising from any use of this software.

    Read the CC license at https://creativecommons.org/publicdomain/zero/1.0/

    NOTES:

        - Written by Guillermo Amodeo Ojeda using as basis MAKEFONT.PHP by
          Olivier Plathey, version 1.82 (Dated 07/12/2019).

        - Core font definitions have been converted from the font definition files
          in the fonts directory that come with FPDF.PHP and MAKEFONT.PHP v1.82

        - This code forces de internal encoding of the PDF to CP1252 enconding
          (aka Windows 1252) while externally uses wchar_t.

                                --oO0Oo--
*/

#include "pdf_font.h"

/* ------------------------------------- *
    Unicode Mapping Tables
 * ------------------------------------- */

pdf_uv_table_t core_table =
{
    0x1AAC,25,
    {
        {2,0x00,0x7F,0x0000}, {1,0x80,0x00,0x20AC}, {1,0x82,0x00,0x201A}, {1,0x83,0x00,0x0192}, {1,0x84,0x00,0x201E},
        {1,0x85,0x00,0x2026}, {2,0x86,0x87,0x2020}, {1,0x88,0x00,0x02C6}, {1,0x89,0x00,0x2030}, {1,0x8A,0x00,0x0160},
        {1,0x8B,0x00,0x2039}, {1,0x8C,0x00,0x0152}, {1,0x8E,0x00,0x017D}, {2,0x91,0x92,0x2018}, {2,0x93,0x94,0x201C},
        {1,0x95,0x00,0x2022}, {2,0x96,0x97,0x2013}, {1,0x98,0x00,0x02DC}, {1,0x99,0x00,0x2122}, {1,0x9A,0x00,0x0161},
        {1,0x9B,0x00,0x203A}, {1,0x9C,0x00,0x0153}, {1,0x9E,0x00,0x017E}, {1,0x9F,0x00,0x0178}, {2,0xA0,0xFF,0x00A0}
    }
};

pdf_uv_table_t zapf_table =
{
    0x2AAC,31,
    {
        {1,0x20, 0x00, 0x0020},{2,0x21, 0x24, 0x2701},{1,0x25, 0x00, 0x260E},{2,0x26, 0x29, 0x2706},{1,0x2A, 0x00, 0x261B},
        {1,0x2B, 0x00, 0x261E},{2,0x2C, 0x47, 0x270C},{1,0x48, 0x00, 0x2605},{2,0x49, 0x6B, 0x2729},{1,0x6C, 0x00, 0x25CF},
        {1,0x6D, 0x00, 0x274D},{1,0x6E, 0x00, 0x25A0},{2,0x6F, 0x72, 0x274F},{1,0x73, 0x00, 0x25B2},{1,0x74, 0x00, 0x25BC},
        {1,0x75, 0x00, 0x25C6},{1,0x76, 0x00, 0x2756},{1,0x77, 0x00, 0x25D7},{2,0x78, 0x7E, 0x2758},{2,0x80, 0x8D, 0x2768},
        {2,0xA1, 0xA7, 0x2761},{1,0xA8, 0x00, 0x2663},{1,0xA9, 0x00, 0x2666},{1,0xAA, 0x00, 0x2665},{1,0xAB, 0x00, 0x2660},
        {2,0xAC, 0xB5, 0x2460},{2,0xB6, 0xD4, 0x2776},{1,0xD5, 0x00, 0x2192},{2,0xD6, 0xD7, 0x2194},{2,0xD8, 0xEF, 0x2798},
        {2,0xF1, 0xFE, 0x27B1}
    }
};

pdf_uv_table_t symbol_table =
{
    0x3AAC,120,
    {
        {1,0x20, 0x00, 0x00A0},{1,0x21, 0x00, 0x0021},{1,0x22, 0x00, 0x2200},{1,0x23, 0x00, 0x0023},{1,0x24, 0x00, 0x2203},
        {2,0x25, 0x26, 0x0025},{1,0x27, 0x00, 0x220B},{2,0x28, 0x29, 0x0028},{1,0x2A, 0x00, 0x2217},{2,0x2B, 0x2C, 0x002B},
        {1,0x2D, 0x00, 0x2212},{2,0x2E, 0x3F, 0x002E},{1,0x40, 0x00, 0x2245},{2,0x41, 0x42, 0x0391},{1,0x43, 0x00, 0x03A7},
        {2,0x44, 0x45, 0x0394},{1,0x46, 0x00, 0x03A6},{1,0x47, 0x00, 0x0393},{1,0x48, 0x00, 0x0397},{1,0x49, 0x00, 0x0399},
        {1,0x4A, 0x00, 0x03D1},{2,0x4B, 0x4E, 0x039A},{2,0x4F, 0x50, 0x039F},{1,0x51, 0x00, 0x0398},{1,0x52, 0x00, 0x03A1},
        {2,0x53, 0x55, 0x03A3},{1,0x56, 0x00, 0x03C2},{1,0x57, 0x00, 0x03A9},{1,0x58, 0x00, 0x039E},{1,0x59, 0x00, 0x03A8},
        {1,0x5A, 0x00, 0x0396},{1,0x5B, 0x00, 0x005B},{1,0x5C, 0x00, 0x2234},{1,0x5D, 0x00, 0x005D},{1,0x5E, 0x00, 0x22A5},
        {1,0x5F, 0x00, 0x005F},{1,0x60, 0x00, 0xF8E5},{2,0x61, 0x62, 0x03B1},{1,0x63, 0x00, 0x03C7},{2,0x64, 0x65, 0x03B4},
        {1,0x66, 0x00, 0x03C6},{1,0x67, 0x00, 0x03B3},{1,0x68, 0x00, 0x03B7},{1,0x69, 0x00, 0x03B9},{1,0x6A, 0x00, 0x03D5},
        {2,0x6B, 0x6E, 0x03BA},{2,0x6F, 0x70, 0x03BF},{1,0x71, 0x00, 0x03B8},{1,0x72, 0x00, 0x03C1},{2,0x73, 0x75, 0x03C3},
        {1,0x76, 0x00, 0x03D6},{1,0x77, 0x00, 0x03C9},{1,0x78, 0x00, 0x03BE},{1,0x79, 0x00, 0x03C8},{1,0x7A, 0x00, 0x03B6},
        {2,0x7B, 0x7D, 0x007B},{1,0x7E, 0x00, 0x223C},{1,0xA0, 0x00, 0x20AC},{1,0xA1, 0x00, 0x03D2},{1,0xA2, 0x00, 0x2032},
        {1,0xA3, 0x00, 0x2264},{1,0xA4, 0x00, 0x2215},{1,0xA5, 0x00, 0x221E},{1,0xA6, 0x00, 0x0192},{1,0xA7, 0x00, 0x2663},
        {1,0xA8, 0x00, 0x2666},{1,0xA9, 0x00, 0x2665},{1,0xAA, 0x00, 0x2660},{1,0xAB, 0x00, 0x2194},{2,0xAC, 0xAF, 0x2190},
        {2,0xB0, 0xB1, 0x00B0},{1,0xB2, 0x00, 0x2033},{1,0xB3, 0x00, 0x2265},{1,0xB4, 0x00, 0x00D7},{1,0xB5, 0x00, 0x221D},
        {1,0xB6, 0x00, 0x2202},{1,0xB7, 0x00, 0x2022},{1,0xB8, 0x00, 0x00F7},{2,0xB9, 0xBA, 0x2260},{1,0xBB, 0x00, 0x2248},
        {1,0xBC, 0x00, 0x2026},{2,0xBD, 0xBE, 0xF8E6},{1,0xBF, 0x00, 0x21B5},{1,0xC0, 0x00, 0x2135},{1,0xC1, 0x00, 0x2111},
        {1,0xC2, 0x00, 0x211C},{1,0xC3, 0x00, 0x2118},{1,0xC4, 0x00, 0x2297},{1,0xC5, 0x00, 0x2295},{1,0xC6, 0x00, 0x2205},
        {2,0xC7, 0xC8, 0x2229},{1,0xC9, 0x00, 0x2283},{1,0xCA, 0x00, 0x2287},{1,0xCB, 0x00, 0x2284},{1,0xCC, 0x00, 0x2282},
        {1,0xCD, 0x00, 0x2286},{2,0xCE, 0xCF, 0x2208},{1,0xD0, 0x00, 0x2220},{1,0xD1, 0x00, 0x2207},{1,0xD2, 0x00, 0xF6DA},
        {1,0xD3, 0x00, 0xF6D9},{1,0xD4, 0x00, 0xF6DB},{1,0xD5, 0x00, 0x220F},{1,0xD6, 0x00, 0x221A},{1,0xD7, 0x00, 0x22C5},
        {1,0xD8, 0x00, 0x00AC},{2,0xD9, 0xDA, 0x2227},{1,0xDB, 0x00, 0x21D4},{2,0xDC, 0xDF, 0x21D0},{1,0xE0, 0x00, 0x25CA},
        {1,0xE1, 0x00, 0x2329},{2,0xE2, 0xE4, 0xF8E8},{1,0xE5, 0x00, 0x2211},{2,0xE6, 0xEF, 0xF8EB},{1,0xF1, 0x00, 0x232A},
        {1,0xF2, 0x00, 0x222B},{1,0xF3, 0x00, 0x2320},{1,0xF4, 0x00, 0xF8F5},{1,0xF5, 0x00, 0x2321},{2,0xF6, 0xFE, 0xF8F6}
    }
};


/* ------------------------------------- *
          Core Fonts Definition
 * ------------------------------------- */

static pdf_font_t  pdf_cour =
{
    0,0,"courier",PDF_FNT_REGULAR,"courier", PDF_FNT_CORE, "Courier", PDF_ENC_CP1252,
    -100,50,629,-157,562,1000,0,TRUE,-23,-250,715,805,0,
    {
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_coub =
{
    0,0,"courier",PDF_FNT_BOLD,"courierb", PDF_FNT_CORE, "Courier-Bold", PDF_ENC_CP1252,
    -100,50,629,-157,562,1000,0,TRUE,-113,-250,749,801,0,
    {
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_coui =
{
    0,0,"courier",PDF_FNT_ITALIC,"courieri", PDF_FNT_CORE, "Courier-Oblique", PDF_ENC_CP1252,
    -100,50,629,-157,562,1000,-12,TRUE,-27,-250,849,805,0,
    {
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_cou2 =
{
    0,0,"courier",PDF_FNT_BOLD|PDF_FNT_ITALIC,"courierbi", PDF_FNT_CORE, "Courier-BoldOblique", PDF_ENC_CP1252,
    -100,50,629,-157,562,1000,-12,TRUE,-57,-250,869,801,0,
    {
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
         600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,  600,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_helr =
{
    0,0,"helvetica",PDF_FNT_REGULAR,"helvetica", PDF_FNT_CORE, "Helvetica", PDF_ENC_CP1252,
    -100,50,718,-207,718,1000,0,FALSE,-166,-225,1000,931,0,
    {
         278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,
         278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,
         278,  278,  355,  556,  556,  889,  667,  191,  333,  333,  389,  584,  278,  333,  278,  278,
         556,  556,  556,  556,  556,  556,  556,  556,  556,  556,  278,  278,  584,  584,  584,  556,
        1015,  667,  667,  722,  722,  667,  611,  778,  722,  278,  500,  667,  556,  833,  722,  778,
         667,  778,  722,  667,  611,  722,  667,  944,  667,  667,  611,  278,  278,  278,  469,  556,
         333,  556,  556,  500,  556,  556,  278,  556,  556,  222,  222,  500,  222,  833,  556,  556,
         556,  556,  333,  500,  278,  556,  500,  722,  500,  500,  500,  334,  260,  334,  584,  350,
         556,  350,  222,  556,  333, 1000,  556,  556,  333, 1000,  667,  333, 1000,  350,  611,  350,
         350,  222,  222,  333,  333,  350,  556, 1000,  333, 1000,  500,  333,  944,  350,  500,  667,
         278,  333,  556,  556,  556,  556,  260,  556,  333,  737,  370,  556,  584,  333,  737,  333,
         400,  584,  333,  333,  333,  556,  537,  278,  333,  333,  365,  556,  834,  834,  834,  611,
         667,  667,  667,  667,  667,  667, 1000,  722,  667,  667,  667,  667,  278,  278,  278,  278,
         722,  722,  778,  778,  778,  778,  778,  584,  778,  722,  722,  722,  722,  667,  667,  611,
         556,  556,  556,  556,  556,  556,  889,  500,  556,  556,  556,  556,  278,  278,  278,  278,
         556,  556,  556,  556,  556,  556,  556,  584,  611,  556,  556,  556,  556,  500,  556,  500,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_helb =
{
    0,0,"helvetica",PDF_FNT_BOLD,"helveticab", PDF_FNT_CORE, "Helvetica-Bold", PDF_ENC_CP1252,
   -100,50,718,-207,718,1000,0,FALSE,-170,-228,1003,962,0,
    {
         278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,
         278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,
         278,  333,  474,  556,  556,  889,  722,  238,  333,  333,  389,  584,  278,  333,  278,  278,
         556,  556,  556,  556,  556,  556,  556,  556,  556,  556,  333,  333,  584,  584,  584,  611,
         975,  722,  722,  722,  722,  667,  611,  778,  722,  278,  556,  722,  611,  833,  722,  778,
         667,  778,  722,  667,  611,  722,  667,  944,  667,  667,  611,  333,  278,  333,  584,  556,
         333,  556,  611,  556,  611,  556,  333,  611,  611,  278,  278,  556,  278,  889,  611,  611,
         611,  611,  389,  556,  333,  611,  556,  778,  556,  556,  500,  389,  280,  389,  584,  350,
         556,  350,  278,  556,  500, 1000,  556,  556,  333, 1000,  667,  333, 1000,  350,  611,  350,
         350,  278,  278,  500,  500,  350,  556, 1000,  333, 1000,  556,  333,  944,  350,  500,  667,
         278,  333,  556,  556,  556,  556,  280,  556,  333,  737,  370,  556,  584,  333,  737,  333,
         400,  584,  333,  333,  333,  611,  556,  278,  333,  333,  365,  556,  834,  834,  834,  611,
         722,  722,  722,  722,  722,  722, 1000,  722,  667,  667,  667,  667,  278,  278,  278,  278,
         722,  722,  778,  778,  778,  778,  778,  584,  778,  722,  722,  722,  722,  667,  667,  611,
         556,  556,  556,  556,  556,  556,  889,  556,  556,  556,  556,  556,  278,  278,  278,  278,
         611,  611,  611,  611,  611,  611,  611,  584,  611,  611,  611,  611,  611,  556,  611,  556,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_heli =
{
    0,0,"helvetica",PDF_FNT_ITALIC,"helveticai", PDF_FNT_CORE, "Helvetica-Oblique", PDF_ENC_CP1252,
    -100,50,718,-207,718,1000,-12,FALSE,-170,-225,1116,931 ,0,
    {
         278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,
         278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,
         278,  278,  355,  556,  556,  889,  667,  191,  333,  333,  389,  584,  278,  333,  278,  278,
         556,  556,  556,  556,  556,  556,  556,  556,  556,  556,  278,  278,  584,  584,  584,  556,
        1015,  667,  667,  722,  722,  667,  611,  778,  722,  278,  500,  667,  556,  833,  722,  778,
         667,  778,  722,  667,  611,  722,  667,  944,  667,  667,  611,  278,  278,  278,  469,  556,
         333,  556,  556,  500,  556,  556,  278,  556,  556,  222,  222,  500,  222,  833,  556,  556,
         556,  556,  333,  500,  278,  556,  500,  722,  500,  500,  500,  334,  260,  334,  584,  350,
         556,  350,  222,  556,  333, 1000,  556,  556,  333, 1000,  667,  333, 1000,  350,  611,  350,
         350,  222,  222,  333,  333,  350,  556, 1000,  333, 1000,  500,  333,  944,  350,  500,  667,
         278,  333,  556,  556,  556,  556,  260,  556,  333,  737,  370,  556,  584,  333,  737,  333,
         400,  584,  333,  333,  333,  556,  537,  278,  333,  333,  365,  556,  834,  834,  834,  611,
         667,  667,  667,  667,  667,  667, 1000,  722,  667,  667,  667,  667,  278,  278,  278,  278,
         722,  722,  778,  778,  778,  778,  778,  584,  778,  722,  722,  722,  722,  667,  667,  611,
         556,  556,  556,  556,  556,  556,  889,  500,  556,  556,  556,  556,  278,  278,  278,  278,
         556,  556,  556,  556,  556,  556,  556,  584,  611,  556,  556,  556,  556,  500,  556,  500,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_hel2 =
{
    0,0,"helvetica",PDF_FNT_BOLD|PDF_FNT_ITALIC,"helveticabi", PDF_FNT_CORE, "Helvetica-BoldOblique", PDF_ENC_CP1252,
    -100,50,718,-207,718,1000,-12,FALSE,-174,-228,1114,962,0,
    {
         278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,
         278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,  278,
         278,  333,  474,  556,  556,  889,  722,  238,  333,  333,  389,  584,  278,  333,  278,  278,
         556,  556,  556,  556,  556,  556,  556,  556,  556,  556,  333,  333,  584,  584,  584,  611,
         975,  722,  722,  722,  722,  667,  611,  778,  722,  278,  556,  722,  611,  833,  722,  778,
         667,  778,  722,  667,  611,  722,  667,  944,  667,  667,  611,  333,  278,  333,  584,  556,
         333,  556,  611,  556,  611,  556,  333,  611,  611,  278,  278,  556,  278,  889,  611,  611,
         611,  611,  389,  556,  333,  611,  556,  778,  556,  556,  500,  389,  280,  389,  584,  350,
         556,  350,  278,  556,  500, 1000,  556,  556,  333, 1000,  667,  333, 1000,  350,  611,  350,
         350,  278,  278,  500,  500,  350,  556, 1000,  333, 1000,  556,  333,  944,  350,  500,  667,
         278,  333,  556,  556,  556,  556,  280,  556,  333,  737,  370,  556,  584,  333,  737,  333,
         400,  584,  333,  333,  333,  611,  556,  278,  333,  333,  365,  556,  834,  834,  834,  611,
         722,  722,  722,  722,  722,  722, 1000,  722,  667,  667,  667,  667,  278,  278,  278,  278,
         722,  722,  778,  778,  778,  778,  778,  584,  778,  722,  722,  722,  722,  667,  667,  611,
         556,  556,  556,  556,  556,  556,  889,  556,  556,  556,  556,  556,  278,  278,  278,  278,
         611,  611,  611,  611,  611,  611,  611,  584,  611,  611,  611,  611,  611,  556,  611,  556,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_timr =
{
    0,0,"times",PDF_FNT_REGULAR,"times", PDF_FNT_CORE, "Times-Roman", PDF_ENC_CP1252,
    -100,50,683,-217,662,1000,0,FALSE,-168,-218,1000,898,0,
    {
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  333,  408,  500,  500,  833,  778,  180,  333,  333,  500,  564,  250,  333,  250,  278,
         500,  500,  500,  500,  500,  500,  500,  500,  500,  500,  278,  278,  564,  564,  564,  444,
         921,  722,  667,  667,  722,  611,  556,  722,  722,  333,  389,  722,  611,  889,  722,  722,
         556,  722,  667,  556,  611,  722,  722,  944,  722,  722,  611,  333,  278,  333,  469,  500,
         333,  444,  500,  444,  500,  444,  333,  500,  500,  278,  278,  500,  278,  778,  500,  500,
         500,  500,  333,  389,  278,  500,  500,  722,  500,  500,  444,  480,  200,  480,  541,  350,
         500,  350,  333,  500,  444, 1000,  500,  500,  333, 1000,  556,  333,  889,  350,  611,  350,
         350,  333,  333,  444,  444,  350,  500, 1000,  333,  980,  389,  333,  722,  350,  444,  722,
         250,  333,  500,  500,  500,  500,  200,  500,  333,  760,  276,  500,  564,  333,  760,  333,
         400,  564,  300,  300,  333,  500,  453,  250,  333,  300,  310,  500,  750,  750,  750,  444,
         722,  722,  722,  722,  722,  722,  889,  667,  611,  611,  611,  611,  333,  333,  333,  333,
         722,  722,  722,  722,  722,  722,  722,  564,  722,  722,  722,  722,  722,  722,  556,  500,
         444,  444,  444,  444,  444,  444,  667,  444,  444,  444,  444,  444,  278,  278,  278,  278,
         500,  500,  500,  500,  500,  500,  500,  564,  500,  500,  500,  500,  500,  500,  500,  500,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_timb =
{
    0,0,"times",PDF_FNT_BOLD,"timesb", PDF_FNT_CORE, "Times-Bold", PDF_ENC_CP1252,
    -100,50,683,-217,676,1000,0,FALSE,-168,-218,1000,935,0,
    {
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  333,  555,  500,  500, 1000,  833,  278,  333,  333,  500,  570,  250,  333,  250,  278,
         500,  500,  500,  500,  500,  500,  500,  500,  500,  500,  333,  333,  570,  570,  570,  500,
         930,  722,  667,  722,  722,  667,  611,  778,  778,  389,  500,  778,  667,  944,  722,  778,
         611,  778,  722,  556,  667,  722,  722, 1000,  722,  722,  667,  333,  278,  333,  581,  500,
         333,  500,  556,  444,  556,  444,  333,  500,  556,  278,  333,  556,  278,  833,  556,  500,
         556,  556,  444,  389,  333,  556,  500,  722,  500,  500,  444,  394,  220,  394,  520,  350,
         500,  350,  333,  500,  500, 1000,  500,  500,  333, 1000,  556,  333, 1000,  350,  667,  350,
         350,  333,  333,  500,  500,  350,  500, 1000,  333, 1000,  389,  333,  722,  350,  444,  722,
         250,  333,  500,  500,  500,  500,  220,  500,  333,  747,  300,  500,  570,  333,  747,  333,
         400,  570,  300,  300,  333,  556,  540,  250,  333,  300,  330,  500,  750,  750,  750,  500,
         722,  722,  722,  722,  722,  722, 1000,  722,  667,  667,  667,  667,  389,  389,  389,  389,
         722,  722,  778,  778,  778,  778,  778,  570,  778,  722,  722,  722,  722,  722,  611,  556,
         500,  500,  500,  500,  500,  500,  722,  444,  444,  444,  444,  444,  278,  278,  278,  278,
         500,  556,  500,  500,  500,  500,  500,  570,  500,  556,  556,  556,  556,  500,  556,  500,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_timi =
{
    0,0,"times",PDF_FNT_ITALIC,"timesi", PDF_FNT_CORE, "Times-Italic", PDF_ENC_CP1252,
    -100,50,683,-217,653,1000,-15,FALSE,-169,-217,1010,883,0,
    {
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  333,  420,  500,  500,  833,  778,  214,  333,  333,  500,  675,  250,  333,  250,  278,
         500,  500,  500,  500,  500,  500,  500,  500,  500,  500,  333,  333,  675,  675,  675,  500,
         920,  611,  611,  667,  722,  611,  611,  722,  722,  333,  444,  667,  556,  833,  667,  722,
         611,  722,  611,  500,  556,  722,  611,  833,  611,  556,  556,  389,  278,  389,  422,  500,
         333,  500,  500,  444,  500,  444,  278,  500,  500,  278,  278,  444,  278,  722,  500,  500,
         500,  500,  389,  389,  278,  500,  444,  667,  444,  444,  389,  400,  275,  400,  541,  350,
         500,  350,  333,  500,  556,  889,  500,  500,  333, 1000,  500,  333,  944,  350,  556,  350,
         350,  333,  333,  556,  556,  350,  500,  889,  333,  980,  389,  333,  667,  350,  389,  556,
         250,  389,  500,  500,  500,  500,  275,  500,  333,  760,  276,  500,  675,  333,  760,  333,
         400,  675,  300,  300,  333,  500,  523,  250,  333,  300,  310,  500,  750,  750,  750,  500,
         611,  611,  611,  611,  611,  611,  889,  667,  611,  611,  611,  611,  333,  333,  333,  333,
         722,  667,  722,  722,  722,  722,  722,  675,  722,  722,  722,  722,  722,  556,  611,  500,
         500,  500,  500,  500,  500,  500,  667,  444,  444,  444,  444,  444,  278,  278,  278,  278,
         500,  500,  500,  500,  500,  500,  500,  675,  500,  500,  500,  500,  500,  444,  500,  444,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_tim2 =
{
    0,0, "times",PDF_FNT_BOLD|PDF_FNT_ITALIC,"timesbi", PDF_FNT_CORE, "Times-BoldItalic", PDF_ENC_CP1252,
    -100,50,683,-217,669,1000,-15,FALSE,-200,-218,996,921,0,
    {
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  389,  555,  500,  500,  833,  778,  278,  333,  333,  500,  570,  250,  333,  250,  278,
         500,  500,  500,  500,  500,  500,  500,  500,  500,  500,  333,  333,  570,  570,  570,  500,
         832,  667,  667,  667,  722,  667,  667,  722,  778,  389,  500,  667,  611,  889,  722,  722,
         611,  722,  667,  556,  611,  722,  667,  889,  667,  611,  611,  333,  278,  333,  570,  500,
         333,  500,  500,  444,  500,  444,  333,  500,  556,  278,  278,  500,  278,  778,  556,  500,
         500,  500,  389,  389,  278,  556,  444,  667,  500,  444,  389,  348,  220,  348,  570,  350,
         500,  350,  333,  500,  500, 1000,  500,  500,  333, 1000,  556,  333,  944,  350,  611,  350,
         350,  333,  333,  500,  500,  350,  500, 1000,  333, 1000,  389,  333,  722,  350,  389,  611,
         250,  389,  500,  500,  500,  500,  220,  500,  333,  747,  266,  500,  606,  333,  747,  333,
         400,  570,  300,  300,  333,  576,  500,  250,  333,  300,  300,  500,  750,  750,  750,  500,
         667,  667,  667,  667,  667,  667,  944,  667,  667,  667,  667,  667,  389,  389,  389,  389,
         722,  722,  722,  722,  722,  722,  722,  570,  722,  722,  722,  722,  722,  611,  611,  500,
         500,  500,  500,  500,  500,  500,  722,  444,  444,  444,  444,  444,  278,  278,  278,  278,
         500,  556,  500,  500,  500,  500,  500,  570,  500,  556,  556,  556,  556,  444,  500,  444,
    },
    &core_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_symb =
{
    0,0,"symbol",PDF_FNT_REGULAR,"symbol", PDF_FNT_CORE, "Symbol", PDF_ENC_CP1252,
    -100,50,740,-200,673,1219,0,FALSE,-180,-293,1090,1010,0,
    {
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,  250,
         250,  333,  713,  500,  549,  833,  778,  439,  333,  333,  500,  549,  250,  549,  250,  278,
         500,  500,  500,  500,  500,  500,  500,  500,  500,  500,  278,  278,  549,  549,  549,  444,
         549,  722,  667,  722,  612,  611,  763,  603,  722,  333,  631,  722,  686,  889,  722,  722,
         768,  741,  556,  592,  611,  690,  439,  768,  645,  795,  611,  333,  863,  333,  658,  500,
         500,  631,  549,  549,  494,  439,  521,  411,  603,  329,  603,  549,  549,  576,  521,  549,
         549,  521,  549,  603,  439,  576,  713,  686,  493,  686,  494,  480,  200,  480,  549,    0,
           0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
           0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
         750,  620,  247,  549,  167,  713,  500,  753,  753,  753,  753, 1042,  987,  603,  987,  603,
         400,  549,  411,  549,  549,  713,  494,  460,  549,  549,  549,  549, 1000,  603, 1000,  658,
         823,  686,  795,  987,  768,  768,  823,  768,  768,  713,  713,  713,  713,  713,  713,  713,
         768,  713,  790,  790,  890,  823,  549,  250,  713,  603,  603, 1042,  987,  603,  987,  603,
         494,  329,  790,  790,  786,  713,  384,  384,  384,  384,  384,  384,  494,  494,  494,  494,
           0,  329,  274,  686,  686,  686,  384,  384,  384,  384,  384,  384,  494,  494,  494,    0,
    },
    &symbol_table,
    NULL,0,0,0
};

/* ------------------------------------- */

static pdf_font_t  pdf_zapf =
{
    0,0, "zapfdingbats",PDF_FNT_REGULAR,    "zapfdingbats", PDF_FNT_CORE, "ZapfDingbats", PDF_ENC_CP1252,
    -100,50,692,-143,705,949,0,FALSE,-1,-143,981,820,0,
    {
           0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
           0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
         278,  974,  961,  974,  980,  719,  789,  790,  791,  690,  960,  939,  549,  855,  911,  933,
         911,  945,  974,  755,  846,  762,  761,  571,  677,  763,  760,  759,  754,  494,  552,  537,
         577,  692,  786,  788,  788,  790,  793,  794,  816,  823,  789,  841,  823,  833,  816,  831,
         923,  744,  723,  749,  790,  792,  695,  776,  768,  792,  759,  707,  708,  682,  701,  826,
         815,  789,  789,  707,  687,  696,  689,  786,  787,  713,  791,  785,  791,  873,  761,  762,
         762,  759,  759,  892,  892,  788,  784,  438,  138,  277,  415,  392,  392,  668,  668,    0,
         390,  390,  317,  317,  276,  276,  509,  509,  410,  410,  234,  234,  334,  334,    0,    0,
           0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
           0,  732,  544,  544,  910,  667,  760,  760,  776,  595,  694,  626,  788,  788,  788,  788,
         788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,
         788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,  788,
         788,  788,  788,  788,  894,  838, 1016,  458,  748,  924,  748,  918,  927,  928,  928,  834,
         873,  828,  924,  924,  917,  930,  931,  463,  883,  836,  836,  867,  867,  696,  696,  874,
           0,  874,  760,  946,  771,  865,  771,  888,  967,  888,  831,  873,  927,  970,  918,    0,
    },
    &zapf_table,
    NULL,0,0,0
};

/* ------------------------------------- */

pdf_font_t  *pdf_core_font_list[15] =
{
    &pdf_cour,&pdf_coub,&pdf_coui,&pdf_cou2,
    &pdf_helr,&pdf_helb,&pdf_heli,&pdf_hel2,
    &pdf_timr,&pdf_timb,&pdf_timi,&pdf_tim2,
    &pdf_symb,&pdf_zapf,
    NULL
};

/* -------------------------------------------------- */

void pdf_free_font(pdf_font_t *fnt)
{
    if(fnt)
    {
        int pos;

        /* Make sure is not a core font */

        for(pos=0; pdf_core_font_list[pos] != NULL; pos++)
        {
            if(fnt == pdf_core_font_list[pos])
                return;
        }

        /* Nope, Let's free it */

        if(fnt->uv)
        {
            switch(fnt->uv->id)
            {
                case  0x1AAC:
                case  0x2AAC:
                case  0x3AAC:
                    break;
                default:
                    free(fnt->uv);
                    break;
            }
        }

        if(fnt->file)
            free(fnt->file);

        memset(fnt,0,sizeof(pdf_font_t));

        free(fnt);
    }
}

/* -------------------------------------------------- */

pdf_font_t *pdf_get_core_font(const char *family,int style)
{
    if(family)
    {
        char key[81],sty[3]={0,0,0};
        int pos = 0;

        /* Ignore style for Symbol and ZpfDingbats */

        if(!strcasecmp(family,"symbol"))
            return &pdf_symb;

        if(!strcasecmp(family,"zapfdingbats"))
            return &pdf_zapf;

        if(style & PDF_FNT_BOLD)
            sty[pos++] = 'b';

        if(style & PDF_FNT_ITALIC)
            sty[pos++] = 'i';

        snprintf(key,81,"%s%s",family,sty);
        strlower(key,key,0);

        for(pos=0; pdf_core_font_list[pos] != NULL; pos++)
        {
            if(!strcmp(pdf_core_font_list[pos]->key,key))
                return pdf_core_font_list[pos];
        }
    }
    return NULL;
}

/* -------------------------------------------------- *
    This bit of code here uses FreeType-1 
    
    Their authors: David Turner, Robert Wilhelm, 
    and Werner Lemberg, put 3 conditions on the use 
    of their code:

    - We don't promise that this software works.
      However, we will be interested in any kind of 
      bug reports. (`as is' distribution)

    - You can  use this software for whatever you
      want, in parts or full form, without having
      to pay us. (`royalty-free' usage)

    - You may not pretend that  you wrote this 
      software. If you use it, or  only parts of it,  
      in a program, you must acknowledge somewhere 
      in your documentation  that  you  have  used  
      the FreeType-1 code. (`credits')

    And here we are complying with them all. :-)
 * -------------------------------------------------- */


#include "freetype/freetype.h"
#include "freetype/ftxkern.h"

static TT_Engine  ttf_eng={0};    		 /* TTF Engine */

/* https://developer.apple.com/fonts/TrueType-Reference-Manual/RM06/Chap6cmap.html */

#define TT_MS_ID_UNICODE_UCS4 10

/* -------------------------------------------------- */

static int ttf_load_info(const wchar_t *fontw,const char *family,pdf_font_t *f)
{
    TT_Error   error;
    TT_UShort  cmid;
    TT_Face_Properties prop = {0};
    TT_Face face = {0};
    TT_CharMap cmap = {0};
    TT_UShort t,pid,eid,lid,nid,len,j,r;
    TT_String *s;
    int ret, fan=0,psn=0,fnn=0,fap=0,psp=0,fnp=0;
    char *str;
    char font[1384] = {0};
    
    if(!fontw || wcstombs(font,fontw,1383)==(size_t)-1)
        return PDF_EINVAL;

    if(!ttf_eng.z && TT_Init_FreeType(&ttf_eng))
        return PDF_ENOTTF;

    error=TT_Open_Face(ttf_eng,font,&face);
    if (error)
        return PDF_EOPEN;

    TT_Get_Face_Properties(face,&prop);

    if(!prop.header || !prop.postscript || !prop.os2 || prop.os2->version == 0xffff)
    {
        TT_Close_Face(face);
        return PDF_EINCORRECT;
    }

    /* Obtain style from properties */

    if((prop.os2->fsType != 2) && (prop.os2->fsType & 0x200))
    {
        /* Opps, this font cannot be embedded by license, so fail */

        TT_Close_Face(face);
        return PDF_EACCES;
    }

    if(prop.os2->fsSelection & 0x01 )
        f->style|=PDF_FNT_ITALIC;

    if(prop.os2->fsSelection & 0x20 )
        f->style|=PDF_FNT_BOLD;

    if(prop.os2->fsSelection & 0x200 )
        f->style|=PDF_FNT_ITALIC;

    if(prop.header->Mac_Style & 2 )
        f->style|=PDF_FNT_ITALIC;

    if(prop.header->Mac_Style & 1 )
        f->style|=PDF_FNT_BOLD;

    /* Obtain font name and family name */    

    for(t=0;t<prop.num_Names;t++)
    {
        if(!TT_Get_Name_ID(face,t,&pid, &eid,&lid, &nid))
        {
            str = NULL;
            switch(nid)
            {
                case TT_NAME_ID_FONT_FAMILY:
                    if(!family && (!fan || fap != 1) && !TT_Get_Name_String(face,t,&s,&len))
                    {
                        str = f->family;
                        fan++;
                        if(pid == TT_PLATFORM_MACINTOSH)
                            fap = 1;
                        else if(fap == 0)
                            fap = 2;
                        else
                            str = NULL;
                    }
                    break;
                case TT_NAME_ID_FULL_NAME:
                    if((!psn && (!fnn || fnp!=1)) && !TT_Get_Name_String(face,t,&s,&len))
                    {
                        str = f->name;
                        fnn++;
                        if(pid == TT_PLATFORM_MACINTOSH)
                            fnp = 1;
                        else if(fnp == 0)
                            fnp = 2;
                        else
                            str = NULL;
                    }
                    break;
                case TT_NAME_ID_PS_NAME:
                    if((!psn || psp != 1) && !TT_Get_Name_String(face,t,&s,&len))
                    {
                        str = f->name;
                        psn++;
                        if(pid == TT_PLATFORM_MACINTOSH)
                            psp = 1;
                        else if(psp == 0)
                            psp = 2;
                        else
                            str = NULL;
                    }
                    break;
                default:
                    break;
            }
            if(str)
            {
                if(pid == TT_PLATFORM_MACINTOSH)
                {
                    r = 0;
                    for(j=0;j<len && r<80;j++)
                    {
                        if(s[j]!=0x20)
                            str[r++] = (char)s[j];
                        else
                            str[r++] = '-';
                    }
                    str[r] = 0;
                }
                else
                {
                    unsigned short tmp[81],ch;

                    j = r = 0;
                    while(j<len && r < 80)
                    {
                        ch = s[j++];
                        ch<<=8;
                        ch = s[j++];
                        if(ch!=0x20)
                            tmp[r++]= ch;
                        else
                            tmp[r++] = L'-';

                    }
                    tmp[r] = 0;
                    utf16_to_utf8((unsigned char *)str,81,tmp,r);
                }
            }
        }

    }

    ret = PDF_EINCORRECT;

    if(family)
        strlower(f->family,family,80);
    else
        strlower(f->family,f->family,0);

    /* Search the CharMaps */

    fap = 0;

    for(t=0;!fap && t<prop.num_CharMaps;t++)
    {
        if(!TT_Get_CharMap_ID(face,t,&pid,&eid))
        {
            switch(pid)
            {
                case TT_PLATFORM_MICROSOFT:
                    switch(eid)
                    {
                        case TT_MS_ID_UNICODE_UCS4:
                        case TT_MS_ID_UNICODE_CS:
                        case TT_MS_ID_SYMBOL_CS:
                            cmid=t;
                            fap++;
                            break;
                        default:
                            break;
                    }
                    break;
                case TT_PLATFORM_APPLE_UNICODE:
                    cmid=t;
                    fap++;
                    break;
                /* Only for old fonts */
                case TT_PLATFORM_ISO:
                    if(eid==TT_ISO_ID_10646)
                    {
                        cmid=t;
                        fap++;
                    }
                default:
                    break;
            }
        }
    }

    if(fap)
    {
        TT_Glyph_Metrics metrics;
        TT_Instance instance;
        TT_Glyph glyph = {0};
        TT_UShort idx;
        float k;
        int ch,wch,tc;

        k = 1000.0 / prop.header->Units_Per_EM;

        f->type = PDF_FNT_TTF;
        f->enc  = PDF_ENC_CP1252;
        f->ut = (int) (k * prop.postscript->underlineThickness);
        f->up = (int) (k * prop.postscript->underlinePosition);

        f->it_ang = (int) prop.postscript->italicAngle;
        f->is_fix = (prop.postscript->isFixedPitch==0) ? FALSE : TRUE;

        f->asc = (int) (k * prop.os2->sTypoAscender);
        f->des = (int) (k * prop.os2->sTypoDescender);

        f->cap = 0;
        f->tal = 0;

        f->xo  = (int)(prop.header->xMin * k);
        f->yo  = (int)(prop.header->yMin * k);
        f->xd  = (int)(prop.header->xMax * k);
        f->yd  = (int)(prop.header->yMax * k);

        f->used = FALSE;

        TT_Get_CharMap(face,cmid,&cmap);

        if(!TT_New_Instance(face,&instance) && !TT_New_Glyph(face,&glyph))
        {
            if (!TT_Load_Glyph(instance,glyph,0,0) && !TT_Get_Glyph_Metrics(glyph,&metrics))
            {
                f->mis_width = (int) (metrics.advance * k);
                for(ch=0;ch<256;ch++)
                {
                    f->cw[ch]= f->mis_width;

                    wch = (int) win1252_to_wchar((char)ch);
                    if(wch != WCHAR_REPLACEMENT)
                    {
                        idx = TT_Char_Index(cmap,(TT_ULong)ch);
                        if(idx && !TT_Load_Glyph(instance,glyph,idx,0) && !TT_Get_Glyph_Metrics(glyph,&metrics))
                        {
                            f->cw[ch]=(int) (metrics.advance * k);
                            if(f->cap == 0 && ch == 72)
                               f->cap = (metrics.bbox.yMax * k); /* Use top of letter H as Capital Height */
                            if(f->asc == 0 && ch == 100)
                               f->asc = (metrics.bbox.yMax * k); /* Use top of letter d as ascender */
                            if(f->des == 0 && ch == 112)
                               f->des = (metrics.bbox.yMax * k); /* Use top of letter p as descender */
                            tc=(int) ((metrics.bbox.yMax - metrics.bbox.yMin) * k);
                            if(tc > f->tal)
                                f->tal = tc;
                        }
                    }
                }

                f->uv = &core_table;
                strlower(f->key,f->family,0);
                if(f->style & PDF_FNT_BOLD)
                    strcat(f->key,"b");
                if(f->style & PDF_FNT_ITALIC)
                    strcat(f->key,"i");

                ret = PDF_OK;
            }
        }

        if(glyph.z)
            TT_Done_Glyph(glyph);

        if(instance.z)
            TT_Done_Instance(instance);
    }

    TT_Close_Face(face);

    return ret;
}

/* -------------------------------------------------- */

int pdf_load_font_file(pdf_font_t **fnt,const wchar_t *font,const char *family)
{
    int ret = PDF_EINVAL;
    pdf_font_t *f = NULL;

    if(fnt && font)
    {
        ret = PDF_ENOMEM;
        f = (pdf_font_t *)calloc(sizeof(pdf_font_t),1);
        if(f)
        {
            ret = PDF_EOPEN;

            f->file = read_compressedw(font,&(f->flen),&(f->forg));
            if(f->file)
            {
                ret = ttf_load_info(font,family,f);
                if(ret)
                {
                    free(f->file);
                    f->file = NULL;
                }
            }
            if(ret)
            {
                free(f);
                f = NULL;
            }
        }
       *fnt = f;
    }
    return ret;
}

/* -------------------------------------------------- */


